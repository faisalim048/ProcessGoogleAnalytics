<?php

/**
 * Google Analytics Process Module v 1.1
 * View your Google Analytics Statistics in the Processwire Admin Panel
 *
 * @author Stefan Wanzenried (Wanze)
 * http://processwire.com/talk/user/582-wanze/	
 * http://www.everchanging.ch
 *
 * ProcessWire 2.x 
 * Copyright (C) 2011 by Ryan Cramer 
 * Licensed under GNU/GPL v2, see LICENSE.TXT
 * 
 * http://www.processwire.com
 * http://www.ryancramer.com
 *
 * 
 * Note:
 * This Module uses the 'Google APIs Client Library for PHP' to query the Statistics
 * http://code.google.com/p/google-api-php-client/
 *
 * To display the charts with javascript, the jquery plugin 'jqplot' is used
 * http://www.jqplot.com/
 */

class ProcessGoogleAnalytics extends Process implements Module, ConfigurableModule {
		
	private $ga_client = null;
	private $ga_service = null;
	private $cache = null;
	private $errors = false;
	
	const PAGE_NAME = 'google-analytics';
	const PERMISSION_NAME = 'ga-view';
	const FACTOR_WIDTH_PERCENT = 0.8;
	
	protected static $defaults = array(
		'clientId' => '',
		'clientSecret' => '',
		'redirectUri' => '',
		'developerKey' => '',
		'accountId' => '',
		'startDate' => '',
		'endDate' => '',
		'maxResults' => 30,
		'cacheTime' => 10800,
		'dateFormat' => '%d %B %Y',
		'chartColor' => '#DB1174',
		'dateFormatInput' => 'Y-m-d',
	);
	
	//Holds the name of cache files generated by MarkupCache. Used by _clearCache Method
	protected static $cacheFiles = array(
		'ga_audience_demographics',
		'ga_audience_mobile',
		'ga_audience_system',
		'ga_audience_visits',
		'ga_audience_visits_stats',
		'ga_content_pageviews',
		'ga_content_stats',
		'ga_traffic_sources_keywords',
		'ga_traffic_sources_referral',
		'ga_traffic_sources_stats',
	);
		
	/**
	 * getModuleInfo is a method required by all modules to tell ProcessWire about them
	 * 
	 * @access public
	 * @static
	 * @return void
	 */
	public static function getModuleInfo() {

		return array(
			'title' => __('Google Analytics',__FILE__),         
			'summary' => __('View your Google Analytics Statistics in the Processwire Admin Panel',__FILE__),
			'version' => 110,
			'href' => 'http://processwire.com/talk/topic/1609-processgoogleanalytics/', 
			'permanent' => false, 
			'permission' => self::PERMISSION_NAME,
			'requires' => 'MarkupCache',
			'installs' => 'MarkupCache',
		);

	}
	
	/**
	 * Check the config, initialize some variables and load all neccessary 3thparty Javascript / Css
	 * 
	 * @access public
	 * @return void
	 */
	public function init() {

		if ($this->_checkConfig()) {
			$this->config->scripts->add($this->config->urls->ProcessGoogleAnalytics . "jqplot/jquery.jqplot.min.js");
			$this->config->scripts->add($this->config->urls->ProcessGoogleAnalytics . "jqplot/excanvas.min.js"); //for IE
			$this->config->styles->add($this->config->urls->ProcessGoogleAnalytics  . "jqplot/jquery.jqplot.min.css");
			$this->config->scripts->add($this->config->urls->ProcessGoogleAnalytics . "jqplot/plugins/jqplot.dateAxisRenderer.min.js");		
			$this->config->scripts->add($this->config->urls->ProcessGoogleAnalytics . "jqplot/plugins/jqplot.highlighter.min.js");		
			$this->_loadGoogleApi();
			$this->cache = $this->modules->get('MarkupCache');
			$this->modules->get('JqueryWireTabs');			
			//Dates: If the dates are empty, set the endDate as today and the startDate a month back
			$this->endDate = ($this->endDate == '') ? date('Y-m-d') : $this->endDate;
			$this->startDate = ($this->startDate == '') ? date('Y-m-d',mktime(0,0,0,date('m')-1,date('d'),date('Y'))) : $this->startDate;
			//Make some config variables available in javascript
			$this->config->js('ga_page_name',self::PAGE_NAME);
			$chartColor = $this->chartColor ? $this->chartColor : self::$defaults['chartColor'];
			$this->config->js('ga_chart_color',$chartColor);
			return parent::init();
		}		

	}

	
	/**
	 * Install module
	 * Create a page and assign this process, create Permission 'ga-view'
	 * 
	 * @access public
	 * @return void
	 */
	public function ___install() { 
		
		parent::___install();		
		$page = $this->pages->get('template=admin,name='.self::PAGE_NAME);
		if (!$page->id) {
			$page = new Page();
			$page->template = $this->templates->get('admin');
			$page->parent = $this->pages->get($this->config->adminRootPageID);
			$page->title = 'Google Analytics';
			$page->name = self::PAGE_NAME;
			$page->process = $this;
			$page->save();			
		}
		$permission = $this->permissions->get(self::PERMISSION_NAME);
		if (!$permission->id) {
			$p = new Permission();
			$p->name = self::PERMISSION_NAME;
			$p->title = $this->_('View Google Analytics Page');
			$p->save();			
		}

	}

	
	/**
	 * Uninstall module
	 * Delete the page 'google-analytics' and Permission 'ga-view'
	 * 
	 * @access public
	 * @return void
	 */
	public function ___uninstall() {

		parent::___uninstall();		
		$permission = $this->permissions->get(self::PERMISSION_NAME);
		if ($permission->id) {
			$permission->delete();		
		}
		$page = $this->pages->get('template=admin,name='.self::PAGE_NAME);
		if ($page->id) {
			$page->delete();		
		}
		$this->_clearCache();
		
	}

	
	/**
	 * Check for errors and return either Authenticate with Oauth / Choose GA Account Dropdown / HTML-Markup to display Statistics
	 * 
	 * @access public
	 * @return html
	 */
	public function ___execute() { 
				
		if (!$this->errors) {
			if ($this->accessToken) { //Do we have an accessToken?
				if ($this->ga_client->getAccessToken()) {
					if ($this->accountId) { //Account already chosen -> generate HTML markup
						return $this->_renderInterface();
					} else { //No account saved, display dropdown to choose Account
						return $this->_selectAccount();
					}
				}
			} else { //Handle Oauth with google
				return $this->_authenticate();
			}
		}
				
	}
		
	
	/**
	 * Clear the Cache files generated by MarkupCache
	 * 
	 * @access private
	 * @return void
	 */
	private function _clearCache() {
		
		foreach (self::$cacheFiles as $file) {
			$this->cache->get($file,0);
		}
		
	}
	
	
	/**
	 * Helper function to store new config options for this module in Database
	 * 
	 * @access private
	 * @param array $data new config values
	 * @return void
	 */
	private function _saveModuleConfig(array $data) {

		$cfg = array_merge($this->data,$data);
		$this->modules->saveModuleConfigData($this,$cfg); //Save Access Token

	}
	
	/**
	 * Helper function to format a ga array with dates as JSON. (For the chart rendered with jqplot)
	 * 
	 * @access private
	 * @param mixed $data
	 * @return json
	 */
	private function _formatChartJSON($data){
	
		$ga_data = array();
		foreach ($data['rows'] as $v) {
			$key = substr($v[0],0,4).'-'.substr($v[0],4,2).'-'.substr($v[0],6,2); //Format date from YYYYMMDD to YYYY-MM-DD
			$value = (int)$v[1]; //Count of visits must be integer otherwise json_encode encodes as string
			$ga_data[] = array($key,$value);
		}
		return json_encode(array($ga_data));

	}
	
	/**
	 * Helper function to render the html tables with 3 columns
	 * 
	 * @access private
	 * @param array $data Contains one or multiple tables
	 * @param string $scope Scope to build a unique ID for the table
	 * @param $totalFrom (default = 'visits') Calculate total from this ga metric (ga:visits,ga:pageviews etc.)
	 * @return html
	 */
	private function _renderStatisticsTables($data, $scope, $totalFrom='visits') {
	    
	    $i = 0;
  		$output = '';
  		foreach ($data as $dimension => $arr) { //First loop: tables, if multiple
      		$display = $i == 0 ? "" : " style='display:none;'"; //Only display the first table
      		$id = "table_{$scope}_{$dimension}";
   			$title = $this->_(ucfirst($dimension)); //The Key of the table array is used to build the title in the first column
   			$output .= "<table class='ga_table toggle_element' id='{$id}'{$display}>";
   			$output .= "<tr>";
   			$output .= "<th class='bg_linear_gradient'>{$title}</th>";
   			$output .= "<th class='bg_linear_gradient'>".$this->_(ucfirst($totalFrom))."</th>";
   			$output .= "<th class='bg_linear_gradient'>".$this->_('% ' . ucfirst($totalFrom))."</th>";
   			$output .= "</tr>";
   			$total = $arr['totalsForAllResults']["ga:{$totalFrom}"];
   			$count = count($arr['rows']);
   			foreach ($arr['rows'] as $k => $value) { //Data Loop
	   			$title = $value[0];
	   			$visits = $value[1];
	   			$percent = (100 / $total) * $visits;
	   			$width = (int)($percent * self::FACTOR_WIDTH_PERCENT);
	   			$percent_str = number_format($percent,2) . ' %';
	   			$display = ($k > 9) ? " style='display:none;'" : "";
	   			$output .= "<tr{$display}>";
	   			$output .= "<td>{$title}</td><td>{$visits}</td><td><div class='percent' style='width: {$width}px;'></div>{$percent_str}</td>";
	   			$output .= "</tr>";
	   			$j = $k+1;
	   			if ($j % 10 == 0 && $j != 1 && $j != $count) {
		   			$n = $count-$j;
		   			$output .= "<tr{$display}>";
		   			$output .= "<td colspan='3' class='more_rows'><a href='#' class='ga_display_more_rows'>".$this->_('view more')." ({$n})</a></td>";
		   			$output .= "</tr>";
	   			}
   			}
   			$output .= "</table>";   			
   			$i++;
  		}
  		return $output;

	}
	
	/**
	 * Get Audience Visits by Date (called via Ajax)
	 * 
	 * @access public
	 * @return json
	 */
	public function ___executeAudiencevisits() {
		
		if (!$data = $this->cache->get("ga_audience_visits",$this->cacheTime)) {						
			$metrics = "ga:visits";
			$opt = array(
				'dimensions' => 'ga:date',
				'sort' => 'ga:date',
			);
			$data = $this->ga_service->data_ga->get($this->accountId,$this->startDate,$this->endDate,$metrics,$opt);
			$data = $this->_formatChartJSON($data);
        	$this->cache->save($data);
        }
        echo $data;
	}
	
	
	/**
	 * Get Audience Visits Stats (called via Ajax)
	 * 
	 * @access public
	 * @return json
	 */
	public function ___executeAudiencevisitsstats() {
		
		if (!$data = $this->cache->get("ga_audience_visits_stats",$this->cacheTime)) {						
			$metrics = "ga:visitors,ga:newVisits,ga:percentNewVisits,ga:visits,ga:bounces,ga:pageviews,ga:visitBounceRate,ga:timeOnSite,ga:avgTimeOnSite";
			$data = $this->ga_service->data_ga->get($this->accountId,$this->startDate,$this->endDate,$metrics);
        	$data = $data['totalsForAllResults'];
        	$titles = array(
        		'ga:visits' => $this->_('Visits Total'),
        		'ga:visitors' => $this->_('Unique Visitors'),
        		'ga:newVisits' => $this->_('New Visits'),
        		'ga:percentNewVisits' => $this->_('New Visits'),
        		'ga:returningVisits' => $this->_('Returning Visits'),
        		'ga:pageviews' => $this->_('Pageviews'),        		
        		'ga:visitBounceRate' => $this->_('Bounce Rate'),
        		'ga:avgTimeOnSite' => $this->_('Avg. Visit Duration'),
        	);
   			$table  = "<table class='ga_table ga_table_highlight' id='ga_table_audience_stats'>";
   			$table .= "<tr>";
   			$i=0;
   			$columns = 4;
   			$tdwidth = 100 / $columns;
   			foreach ($titles as $k => $title) {
   				if($i % $columns == 0) $table .= "</tr><tr>";
   				$value = (array_key_exists($k,$data)) ? $data[$k] : '';
   				switch($k){
   					case 'ga:percentNewVisits':
   					case 'ga:visitBounceRate':
   						$value = number_format($value,2) . ' %';
   						break;
   					case 'ga:avgTimeOnSite':
   						$value = gmdate('H:i:s',$value);
   						break;
   					case 'ga:returningVisits':
   						$value = number_format($data['ga:visits'] - $data['ga:newVisits']);
   						break;
   					default:
   						$value = number_format($value);
   				}
   				$table .= "<td style='width: {$tdwidth}%;' class='bg_linear_gradient'>{$value}<br><span class='desc'>{$title}</span></td>";
   				$i++;
   			}
   			$table .= "</tr>";
   			$table .= "</table>";
   			$data = $table;
        	$this->cache->save($data);
        }
        echo $data;
		
	}
	
	/**
	 * Get demographics statistics (Visits by Countries / Cities / Languages) (called via Ajax)
	 * 
	 * @access public
	 * @return html
	 */
	public function ___executeAudiencedemographics() {
				
		if (!$data = $this->cache->get("ga_audience_demographics",$this->cacheTime)) {						
			$metrics = "ga:visits";
			$opt = array(
				'dimensions' => 'ga:country',
				'sort' => '-ga:visits',
				'max-results' => $this->maxResults,
			);
			$data = array();
			$data_countries = $this->ga_service->data_ga->get($this->accountId,$this->startDate,$this->endDate,$metrics,$opt);
        	$opt['dimensions'] = 'ga:city';
			$data_cities = $this->ga_service->data_ga->get($this->accountId,$this->startDate,$this->endDate,$metrics,$opt);
        	$opt['dimensions'] = 'ga:language';
			$data_languages = $this->ga_service->data_ga->get($this->accountId,$this->startDate,$this->endDate,$metrics,$opt);        	
      		$data['country'] = $data_countries;
      		$data['city'] = $data_cities;
      		$data['language'] = $data_languages;      		
        	$data = $this->_renderStatisticsTables($data,'demographics');
        	$this->cache->save($data);
        }
        echo $data;

	}		

	/**
	 * Get System Statistics (Visits by Browser / OS / Resolution) (called via Ajax)
	 * 
	 * @access public
	 * @return html
	 */
	public function ___executeAudiencesystem() {
				
		if (!$data = $this->cache->get("ga_audience_system",$this->cacheTime)) {						
			$metrics = "ga:visits";
			$opt = array(
				'dimensions' => 'ga:browser',
				'sort' => '-ga:visits',
				'max-results' => $this->maxResults,
			);
			$data = array();
			$data_browser = $this->ga_service->data_ga->get($this->accountId,$this->startDate,$this->endDate,$metrics,$opt);
        	$opt['dimensions'] = 'ga:operatingSystem';
			$data_os = $this->ga_service->data_ga->get($this->accountId,$this->startDate,$this->endDate,$metrics,$opt);
        	$opt['dimensions'] = 'ga:screenResolution';
			$data_resolution = $this->ga_service->data_ga->get($this->accountId,$this->startDate,$this->endDate,$metrics,$opt);        	
      		$data['browser'] = $data_browser;
      		$data['os'] = $data_os;
      		$data['resolution'] = $data_resolution;      		
      		$data = $this->_renderStatisticsTables($data,'system');
        	$this->cache->save($data);
        }
        echo $data;

	}		

	/**
	 * Get Mobile Statistics (Visits by OS / Resolution) (called via Ajax)
	 * 
	 * @access public
	 * @return html
	 */
	public function ___executeAudiencemobile() {
				
		if (!$data = $this->cache->get("ga_audience_mobile",$this->cacheTime)) {						
			$metrics = "ga:visits";
			$opt = array(
				'dimensions' => 'ga:operatingSystem',
				'sort' => '-ga:visits',
				'max-results' => $this->maxResults,
				'segment' => 'gaid::-11',
			);
			$data = array();
			$data_os = $this->ga_service->data_ga->get($this->accountId,$this->startDate,$this->endDate,$metrics,$opt);
        	$opt['dimensions'] = 'ga:screenResolution';
			$data_resolution = $this->ga_service->data_ga->get($this->accountId,$this->startDate,$this->endDate,$metrics,$opt);        	
      		$data['os'] = $data_os;
      		$data['resolution'] = $data_resolution;      		
      		$data = $this->_renderStatisticsTables($data,'mobile');
        	$this->cache->save($data);
        }
        echo $data;

	}		
	
	/**
	 * Get Content Pageviews by Date (called via Ajax)
	 * 
	 * @access public
	 * @return json
	 */
	public function ___executeContentpageviews() {
		
		if (!$data = $this->cache->get("ga_content_pageviews",$this->cacheTime)) {						
			$metrics = "ga:pageviews";
			$opt = array(
				'dimensions' => 'ga:date',
				'sort' => 'ga:date',
			);
			$data = $this->ga_service->data_ga->get($this->accountId,$this->startDate,$this->endDate,$metrics,$opt);
        	$data = $this->_formatChartJSON($data);
        	$this->cache->save($data);
        }
        echo $data;
	}

	/**
	 * Get Content Stats (called via Ajax)
	 * 
	 * @access public
	 * @return json
	 */
	public function ___executeContentstats() {
		
		if (!$data = $this->cache->get("ga_content_stats",$this->cacheTime)) {						
			//1st: Get Pageviews and Unique Pageviews
			$metrics = "ga:pageviews,ga:uniquePageviews";
			$data = $this->ga_service->data_ga->get($this->accountId,$this->startDate,$this->endDate,$metrics);
        	$data = $data['totalsForAllResults'];
        	$titles = array(
        		'ga:pageviews' => $this->_('Pageviews Total'),
        		'ga:uniquePageviews' => $this->_('Unique Pageviews Total'),
        	);
   			$output = "<div style='width: 25%; margin-right: 10px; float:left;'>";
   			$table  = "<table class='ga_table ga_table_highlight' id='ga_table_content_stats'>";
   			$table .= "<tr>";
   			$i=0;
   			foreach ($titles as $k => $title) {
   				if($i % 1 == 0) $table .= "</tr><tr>";
   				$value = number_format($data[$k]);
   				$table .= "<td class='bg_linear_gradient'>{$value}<br><span class='desc'>{$title}</span></td>";
   				$i++;
   			}
   			$table .= "</tr>\n";
   			$table .= "</table>\n";
   			$output .= $table;
   			$output .= "</div>";
   			$output .= "<div style='float: left; width: 73%;'>";
			
			//2nd: Get Top Sites by path sorted by pageviews
			$metrics = "ga:pageviews";
			$opt = array(
				'dimensions' => 'ga:pagePath',
				'sort' => '-ga:pageviews',
				'max-results' => $this->maxResults,
			);
			$data = array();
			$data['page'] = $this->ga_service->data_ga->get($this->accountId,$this->startDate,$this->endDate,$metrics,$opt);
   			$output .= $this->_renderStatisticsTables($data,'content_pageviews','pageviews');
   			$output .= "</div>";
   			$output .= "";
   			$output .= "<div style='clear:both;'></div>";
   			$data = $output;
        	$this->cache->save($data);
        }
        echo $data;
		
	}
	
	
	/**
	 * Get Traffic Sources (direct / referral / organic) (called via ajax)
	 * 
	 * @access public
	 * @return html
	 */
	public function ___executeTrafficsourcesstats(){
		
		if (!$data = $this->cache->get("ga_traffic_sources_stats",$this->cacheTime)) {						
			$metrics = "ga:visits";
			$opt = array(
				'dimensions' => 'ga:medium',
				'max-results' => $this->maxResults,
			);
			$data = $this->ga_service->data_ga->get($this->accountId,$this->startDate,$this->endDate,$metrics,$opt);
   			$table  = "<table class='ga_table ga_table_highlight' id='ga_table_traffic_sources_stats'>";
   			$table .= "<tr>";
   			$i=0;
   			$columns = 3;
   			$tdwidth = 100 / $columns;
   			$total = $data['totalsForAllResults']['ga:visits'];
   			foreach ($data['rows'] as $k => $value) {
   				if ($i % $columns == 0) $table .= "</tr><tr>";
   				$title = $value[0];
   				if ($k == 0) $title = 'Direct';
   				$title = $this->_(ucfirst($title) . ' Traffic');
   				$visits = $value[1];
   				$percent = number_format(((100 / $total) * $visits),2);
   				$table .= "<td style='width: {$tdwidth}%;' class='bg_linear_gradient'>{$percent} %<br><span class='desc'>{$title} ({$visits} ".$this->_('visits').")</span></td>";
   				$i++;
   			}
   			$table .= "</tr>";
   			$table .= "</table>";
   			$data = $table;
        	$this->cache->save($data);
        }
        echo $data;
	
	}
	
	
	/**
	 * Get the keywords (called via Ajax)
	 * 
	 * @access public
	 * @return html
	 */
	public function ___executeTrafficsourceskeywords() {
				
		if (!$data = $this->cache->get("ga_traffic_sources_keywords",$this->cacheTime)) {						
			$metrics = "ga:visits";
			$opt = array(
				'dimensions' => 'ga:keyword',
				'sort' => '-ga:visits',
				'max-results' => $this->maxResults,
			);
			$data = array();
      		$data['keyword'] = $this->ga_service->data_ga->get($this->accountId,$this->startDate,$this->endDate,$metrics,$opt);
        	$data = $this->_renderStatisticsTables($data,'keywords');
        	$this->cache->save($data);
        }
        echo $data;

	}		


	/**
	 * Get referral Traffic (called via Ajax)
	 * 
	 * @access public
	 * @return html
	 */
	public function ___executeTrafficsourcesreferral() {
				
		if (!$data = $this->cache->get("ga_traffic_sources_referral",$this->cacheTime)) {						
			$metrics = "ga:visits";
			$opt = array(
				'dimensions' => 'ga:source',
				'sort' => '-ga:visits',
				'max-results' => $this->maxResults,
				'filters' => 'ga:medium==referral',
			);
			$data = array();
      		$data['source'] = $this->ga_service->data_ga->get($this->accountId,$this->startDate,$this->endDate,$metrics,$opt);
        	$data = $this->_renderStatisticsTables($data,'source');
        	$this->cache->save($data);
        }
        echo $data;

	}		
	
	
	/**
	 * Change options (date range) (called via Ajax)
	 * 
	 * @access public
	 * @return void
	 */
	public function ___executeChangeoptions() {
	
		$input = wire('input');
		$startDate = $input->post->startDate;
		$endDate = $input->post->endDate;
		//Need to format the dates to YYYY-MM-DD?
		if ($startDate != '' && $endDate != '' && $this->dateFormatInput != 'Y-m-d') {
			$startTs = FieldtypeDatetime::stringToTimestamp($startDate,$this->dateFormatInput);
			$endTs = FieldtypeDatetime::stringToTimestamp($endDate,$this->dateFormatInput);
			$startDate = date('Y-m-d',$startTs);
			$endDate = date('Y-m-d',$endTs);			
		}
		$this->_saveModuleConfig(array('startDate' => $startDate, 'endDate' => $endDate));
		$this->_clearCache();
		return;
	
	}
		
	/**
	 * Render the required HTML-Markup to display the statistics loaded via Ajax
	 * 
	 * @access private
	 * @return html
	 */
	private function _renderInterface() {
		
		$form = $this->modules->get('InputfieldForm');
		$form->attr('id','ga_form');
		
		//Wrapper are used to separate main sections with JqueryWireTabs
		$wrapper_audience = new InputfieldWrapper();
		$wrapper_audience->attr('id','audienceWrapper');
		$wrapper_audience->attr('title',$this->_('Audience'));
		$wrapper_content = new InputfieldWrapper();
		$wrapper_content->attr('title',$this->_('Content'));
		$wrapper_content->attr('id','contentWrapper');
		$wrapper_traffic = new InputfieldWrapper();
		$wrapper_traffic->attr('title',$this->_('Traffic Sources'));
		$wrapper_traffic->attr('id','trafficWrapper');
		$wrapper_options = new InputfieldWrapper();
		$wrapper_options->attr('title',$this->_('Options'));		
		$wrapper_options->attr('id','optionsWrapper');		
		
		//Options to change the date range
		$date_from = $this->modules->get('InputfieldDatetime');
		$date_from->label = $this->_('Start date');
		$date_from->attr('id','ga_startDate');
		$date_from->attr('value',$this->startDate);
		$date_from->dateInputFormat = $this->dateFormatInput;
		$date_to = $this->modules->get('InputfieldDatetime');
		$date_to->label = $this->_('End date');
		$date_to->attr('id','ga_endDate');
		$date_to->attr('value',$this->endDate);
		$date_to->dateInputFormat = $this->dateFormatInput;
		$checkbox = $this->modules->get('InputfieldCheckbox');
		$checkbox->label = $this->_('Reset custom dates?');
		$checkbox->description = $this->_('If checked, the module will display Statistics from the last month again');
		$checkbox->attr('id','ga_defaultDates');
		$button = $this->modules->get('InputfieldButton');
		$button->attr('id','ga_saveOptions');
		$button->attr('value',$this->_('Save'));
		$wrapper_options->append($date_from);
		$wrapper_options->append($date_to);
		$wrapper_options->append($checkbox);		
		$wrapper_options->append($button);
		
		//Audience - Visits
		$html  = "<div id='audience_visits_chart' class='ga_chart_lines'></div>";
		$html .= "<div id='audience_visits_stats'></div>";		
		$field = $this->modules->get("InputfieldMarkup"); 
		$field->label = $this->_("Visits");
		$field->attr('value',$html);
		$wrapper_audience->append($field);
		
		//Audience - Demographics
		$field = $this->modules->get("InputfieldMarkup"); 
		$field->label = $this->_("Demographics");
		$field->columnWidth = 33;
		$html  = "<div class='ga_header_links'>";
		$html .= "<a href='#table_demographics_country' class='on'>".$this->_('Countries')."</a> / ";
		$html .= "<a href='#table_demographics_city'>".$this->_('Cities')."</a> / ";
		$html .= "<a href='#table_demographics_language'>".$this->_('Languages')."</a>";
		$html .= "</div>";
		$html .= "<div id='audience_demographics'></div>";
		$field->attr('value',$html);
		$wrapper_audience->append($field);
		
		//Audience - System
		$field = $this->modules->get("InputfieldMarkup"); 
		$field->label = $this->_("System");
		$field->columnWidth = 33;
		$html  = "<div class='ga_header_links'>";
		$html .= "<a href='#table_system_browser' class='on'>".$this->_('Browsers')."</a> / ";
		$html .= "<a href='#table_system_os'>".$this->_('Operating Systems')."</a> / ";
		$html .= "<a href='#table_system_resolution'>".$this->_('Screen Resolutions')."</a>";
		$html .= "</div>";
		$html .= "<div id='audience_system'></div>";
		$field->attr('value',$html);
		$wrapper_audience->append($field);		

		//Audience - Mobile
		$field = $this->modules->get("InputfieldMarkup"); 
		$field->label = $this->_("Mobile");
		$field->columnWidth = 33;
		$html  = "<div class='ga_header_links'>";
		$html .= "<a href='#table_mobile_os' class='on'>".$this->_('Operating Systems')."</a> / ";
		$html .= "<a href='#table_mobile_resolution'>".$this->_('Screen Resolutions')."</a>";
		$html .= "</div>";
		$html .= "<div id='audience_mobile'></div>";
		$field->attr('value',$html);
		$wrapper_audience->append($field);		
		
		//Content Stats
		$html  = "<div id='content_pageviews_chart' class='ga_chart_lines'></div>";
		$html .= "<div id='content_stats'></div>";
		$field = $this->modules->get("InputfieldMarkup"); 
		$field->label = $this->_("Pageviews");
		$field->attr('value',$html);
		$wrapper_content->append($field);
		
		//Traffic Sources Statistics
		$field = $this->modules->get("InputfieldMarkup"); 
		$field->label = $this->_("Statistics");
		$field->attr('value',"<div id='traffic_sources_stats'></div>");
		$wrapper_traffic->append($field);

		//Traffic - Kewyords
		$field = $this->modules->get("InputfieldMarkup"); 
		$field->label = $this->_("Keywords");
		$field->columnWidth = 50;
		$field->attr('value',"<div id='traffic_sources_keywords'></div>");
		$wrapper_traffic->append($field);		

		//Traffic - Referral Traffic
		$field = $this->modules->get("InputfieldMarkup"); 
		$field->label = $this->_("Referral Traffic (Sources)");
		$field->columnWidth = 50;
		$field->attr('value',"<div id='traffic_sources_referral'></div>");
		$wrapper_traffic->append($field);		
		
		$form->append($wrapper_audience);
		$form->append($wrapper_content);
		$form->append($wrapper_traffic);
		$form->append($wrapper_options);
		
		$startDate = strftime($this->dateFormat,strtotime($this->startDate));
		$endDate = strftime($this->dateFormat,strtotime($this->endDate));
		return "<h2>{$startDate} - {$endDate}</h2>" . $form->render();

	}
		
	/**
	 * Handle authentication with Google over Oauth. 
	 * Display a button to authenticate and stores accessToken in Module afterwards.
	 * 
	 * @access private
	 * @return html
	 */
	private function _authenticate() {

		if ($this->input->get->code) {
			$this->ga_client->authenticate();
			$accessToken = $this->ga_client->getAccessToken();
			$this->_saveModuleConfig(array('accessToken' => $accessToken));
			$this->session->redirect('./');
		} else {
			$authUrl = $this->ga_client->createAuthUrl();
			$fieldset = $this->modules->get('InputfieldFieldset');
			$fieldset->description = $this->_("You must login with your Google Account and grant the API access to your Google Analytics Statistics. You will be redirected to this page again afterwards to choose the Analytics Account.\nNote: This step is only necessary once, an Access Token is stored in the Database.");			
			$button = $this->modules->get('InputfieldButton');
			$button->title = 'test';
			$button->attr('id+name','ga_oauth');
			$button->attr('href',$authUrl);
			$button->attr('value',$this->_('Authenticate'));
			$fieldset->add($button);
			return $fieldset->render();
		}

	}
	
	
	/**
	 * Display a Dropdown to choose the GA Account (Statistics are displayed from this Account)
	 * 
	 * @access private
	 * @return html
	 */
	private function _selectAccount() {
		
		if ($this->input->post->account_id !== null) {
			$account_id = $this->input->post->account_id;
			$account_id = "ga:$account_id";
			$this->_saveModuleConfig(array('accountId' => $account_id));
			$this->session->redirect('./');			
		}
		
		//Create form to select GA Account
		$this->_clearCache(); //In case the User revoked Authentication or changed GA Account -> empty Cache 
		$form = $this->modules->get('InputfieldForm');
		$form->attr('name+id','ga_form_set_account');
		$select = $this->modules->get('InputfieldSelect');
		$select->attr('name+id','account_id');
		$select->label = $this->_('Choose Google Analytics Account');
		$button = $this->modules->get('InputfieldSubmit');
		$button->attr('id+name','ga_set_account');
		$button->attr('value',$this->_('Save'));
		
		//Build Array with the ga_id as key, account name as value. Note: The correct gaID is found only in the $profiles array 
		$props = $this->ga_service->management_webproperties->listManagementWebproperties("~all");
		$profiles = $this->ga_service->management_profiles->listManagementProfiles("~all", "~all");
		$accounts = array();
		foreach ($props['items'] as $k => $account) {
			//Need to find the coorect ga_id in the $profiles array... :/
			foreach ($profiles['items'] as $pk => $profile) {
				if ($account['internalWebPropertyId'] == $profile['internalWebPropertyId']) {
					$ga_id = $profile['id'];
					$account_name = $account['name'];
					$accounts[$ga_id] = $account_name;
					break;
				}
			}
		}
		$select->addOptions($accounts);
		$form->append($select);
		$form->append($button);
		return $form->render();

	}
	
	
	/**
	 * Load and initialize the Google Analytics API
	 * 
	 * @access private
	 * @return void
	 */
	private function _loadGoogleApi() {

		include_once($this->config->paths->ProcessGoogleAnalytics . 'google_api_client/src/apiClient.php');
		include_once($this->config->paths->ProcessGoogleAnalytics . 'google_api_client/src/contrib/apiAnalyticsService.php');
		$this->ga_client = new apiClient();
		$this->ga_client->setClientId($this->clientId);
		$this->ga_client->setClientSecret($this->clientSecret);
		$this->ga_client->setRedirectUri($this->redirectUri);
		$this->ga_client->setDeveloperKey($this->developerKey);
		$this->ga_service = new apiAnalyticsService($this->ga_client);
		if ($this->accessToken) { //Set the accessToken to ga client instance
			$this->ga_client->setAccessToken($this->accessToken);	
		}	

	}
	
	
	/**
	 * Check if the module is configured correctly
	 * 
	 * @access private
	 * @return boolean
	 */
	private function _checkConfig() {
		
		if(wire('input')->get->uninstalled || wire('input')->get->name == $this->className) return true; //Prepend showing warnings on module edit mask...
		$errors = array();
		if (!$this->clientId) $errors[] = $this->_('API Key is missing');
		if (!$this->clientSecret) $errors[] = $this->_('Client Secret Key is missing');
		if (!$this->redirectUri) $errors[] = $this->_('Redirect URI is missing');
		if (!$this->developerKey) $errors[] = $this->_('Developer Key is missing');
		if (count($errors) > 0) {
			$this->errors = true;
			foreach ($errors as $error) {
				$this->error($error);		
			}
			return false;
		}
		return true;

	}
	
	
	/**
	 * Config Options for this Module
	 * 
	 * @access public
	 * @static
	 * @param array $data
	 * @return InputfieldWrapper
	 */
	static public function getModuleConfigInputfields(array $data) {
		
		$data = array_merge(self::$defaults, $data);
		if (trim($data['redirectUri']) == '') {
			$data['redirectUri'] = 'http://' . $_SERVER['HTTP_HOST'] . wire('config')->urls->admin . self::PAGE_NAME .'/';
		} 
		$fields = new InputfieldWrapper();
		$modules = wire('modules');
		
		//Revoke authentication checked previous?
		$revoke = wire('input')->post->_revokeAuth ? true : false;
		if ($revoke) {
			$data = array_merge($data,array('accountId' => '', 'accessToken' => ''));
			if ($modules->saveModuleConfigData($modules->get('ProcessGoogleAnalytics'),$data)){
				wire('session')->redirect('./edit?name=ProcessGoogleAnalytics');
			}
		}
				
		//Client ID
		$field = $modules->get("InputfieldText");
		$field->attr('name+id', 'clientId');
		$field->attr('value', $data['clientId']);
		$field->label = "Client ID";
		$field->description = 'Enter the Client ID from the Google APIs console';
		$fields->append($field);
		
		//Client secret Key
		$field = $modules->get("InputfieldText");
		$field->attr('name+id', 'clientSecret');
		$field->attr('value', $data['clientSecret']);
		$field->label = "Client Secret";
		$field->description = 'Enter the Client Secret from the Google APIs console';
		$fields->append($field);

		//API Key
		$field = $modules->get("InputfieldText");
		$field->attr('name+id', 'developerKey');
		$field->attr('value', $data['developerKey']);
		$field->label = "API Key (Developer Key)";
		$field->description = 'Enter the API key from the Google APIs console';
		$fields->append($field);

		//Redirect URI
		$field = $modules->get("InputfieldText");
		$field->attr('name+id', 'redirectUri');
		$field->attr('value', $data['redirectUri']);
		$field->label = "Redirect URI";
		$field->description = "The URI must match one url provided in the Google APIs Console";
		$fields->append($field);
		
		//Ga Account ID - only display when Account was chosen with dropdown before
		if ($data['accountId']) {
			$field = $modules->get("InputfieldText");
			$field->attr('name+id', 'accountId');
			$field->attr('value', $data['accountId']);
			$field->label = "Google Analytics Account Id";
			$field->description = "Statistics are displayed from this Google Analytics Account-ID. Simply delete this ID and you can choose another Account again.";
			$fields->append($field);			
		}

		//Max Results
		$field = $modules->get("InputfieldInteger");
		$field->attr('name+id', 'maxResults');
		$field->attr('value', $data['maxResults']);
		$field->label = "Max number of results returned by the queries";
		$fields->append($field);

		//Cache Time for Results
		$field = $modules->get("InputfieldInteger");
		$field->attr('name+id', 'cacheTime');
		$field->attr('value', $data['cacheTime']);
		$field->label = "Cache Time (seconds)";
		$field->description = "How long do you want to cache the results? Default value is 3 hours";
		$fields->append($field);

		//Chart Color
		$field = $modules->get("InputfieldText");
		$field->attr('name+id', 'chartColor');
		$field->attr('value', $data['chartColor']);
		$field->label = "Chart Color";
		$field->description = "Hex Code used by jqplot to render the chart lines";
		$fields->append($field);

		//Date Format for date range in the header
		$field = $modules->get("InputfieldText");
		$field->attr('name+id', 'dateFormat');
		$field->attr('value', $data['dateFormat']);
		$field->label = "Date Format Header";
		$field->description = "String used by php's strftime function to format From - To date in the Header";
		$fields->append($field);

		//Date Format for Datetime Inputfields
		$field = $modules->get("InputfieldText");
		$field->attr('name+id', 'dateFormatInput');
		$field->attr('value', $data['dateFormatInput']);
		$field->label = "Date Format Inputfields";
		$field->description = "String used by php's date function to set the format of the InputfieldDatetime fields in the Options section";
		$fields->append($field);

		//Revoke authentication
		$name = "_revokeAuth"; // prefix with '_' tells ProcessModule not to save it in module's config data
		$field = $modules->get('InputfieldCheckbox');
		$field->attr('name', $name);
		$field->attr('value', 1);
		$field->attr('checked', '');
		$field->label = "Revoke Authentication?";
		$field->description = "Check to revoke Oauth Authentication with Google";
		$fields->append($field);

		return $fields;
	}
}